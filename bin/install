#!/usr/bin/env sh

#
# Setup War Machine on Linux (Debian)
#

set -ex

export RUNZSH=no
export CHSH=no
export ZSH=$HOME/.oh-my-zsh

war_machine=$HOME/.war_machine
zsh_plugins=$ZSH/plugins

rm -rf $war_machine/dependencies
rm -rf $ZSH
rm -rf /root/.rbenv/plugins/ruby-build

#
# War Machine
#
git clone -b docker https://github.com/ammancilla/war_machine.git $war_machine

#
# Prepare
#
apt-key adv --fetch-keys https://packages.cloud.google.com/apt/doc/apt-key.gpg
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" >> /etc/apt/sources.list.d/kubernetes.list


apt-get update && apt-get upgrade -y && apt-get autoclean
apt-get install -y git man less vim tmux jq zsh thefuck rbenv locales apt-transport-https

# Ensure locale en_US.UTF-8
# Warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
# https://github.com/CentOS/sig-cloud-instance-images/issues/71#issuecomment-266959225
localedef -i en_US -f UTF-8 en_US.UTF-8

#
# THE SHELL
#
# --- Oh My ZSH
sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"

# War Machine
# git clone git@github.com:ammancilla/war_machine.git $HOME/.war_machine

#
# DOTFILES
#
# - .zshrc
#
# --- dracula
git clone https://github.com/dracula/zsh.git $war_machine/dependencies/dracula/
ln -s $war_machine/dependencies/dracula/dracula.zsh-theme $ZSH/themes/dracula.zsh-theme

# --- gh
mkdir $zsh_plugins/gh
wget https://raw.githubusercontent.com/jdxcode/gh/master/zsh/gh/_gh -O $zsh_plugins/gh/_gh
wget https://raw.githubusercontent.com/jdxcode/gh/master/zsh/gh/gh.plugin.zsh -O $zsh_plugins/gh/gh.plugin.zsh

# --- git open
git clone https://github.com/paulirish/git-open.git $ZSH/plugins/git-open

# --- rbenv
mkdir -p "$(rbenv root)"/plugins
git clone https://github.com/rbenv/ruby-build.git "$(rbenv root)"/plugins/ruby-build


rm -f $HOME/.vimrc $HOME/.tmux.conf $HOME/.zshrc

ln -s $war_machine/vimrc $HOME/.vimrc && \
ln -s $war_machine/zshrc $HOME/.zshrc && \
ln -s $war_machine/tmux.conf $HOME/.tmux.conf

#
# OPERATIONS
#
# --- Kubectl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" >> /etc/apt/sources.list.d/kubernetes.list
apt-get update && apt-get install -y apt-transport-https kubectl


# --- Kubectx & Kubens
wget https://raw.githubusercontent.com/ahmetb/kubectx/master/kubectx -O /usr/local/bin/kubectx
wget https://raw.githubusercontent.com/ahmetb/kubectx/master/kubens -O /usr/local/bin/kubens

chmod +x /usr/local/bin/kubectx /usr/local/bin/kubens

exec zsh -l
